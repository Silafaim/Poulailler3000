#include <Arduino.h>
#include <NTPClient.h>
#include <WiFi.h> 
#include <WiFiUdp.h>
#include <CSV_Parser.h>
#include <TimeLib.h>
#include <AsyncTCP.h>
#include <ESPAsyncWebServer.h>
#include <WebSerial.h>

const char *ssid     = "NETGEAR94";
const char *password = "00000000";

// Configuration des broches utilisées
const int ALIM_RELAY_PIN = 27;    // Broche du contacteur de l'alim
const int MOTOR_RELAY_PIN = 12;   // Broche du contacteur du moteur
const int END_SWITCH_PIN = 32;     // Broche de l'interrupteur de fin de course

const int timeToOpen_ms = 8000; // Le temps que le moteur doit tourner pour ouvrir totalement la porte
const int timeToClose_ms = 3100; // Le temps que le moteur doit tourner pour fermer totalement la porte
WiFiUDP ntpUDP;
NTPClient timeClient(ntpUDP,"pool.ntp.org",7200,120000);
AsyncWebServer server(80);

int epoch;
int currentHour;
int currentMin;
int yearVar = 0;
int monthVar = 0;
int dayVar = 0;
char** dates_CSV;
char** lever_CSV;
char** coucher_CSV;
String leverStr;
String coucherStr;
String sunriseHour;
String sunsetHour;
String sunriseMin;
String sunsetMin;
//int sunriseHour;
//int sunsetHour;
//int sunriseMin;
//int sunsetMin;
bool isDaytime;
bool doorIsOpen = true; // AU DEMARRAGE, LA PORTE DOIT ETRE OUVERTE 
int dayNumber; 
//int riseOffsetHour = 0;
//int riseOffsetMin = 0;
//int setOffsetHour = 0;
//int setOffsetMin = 0;

void setup() {
  pinMode(ALIM_RELAY_PIN, OUTPUT);
  pinMode(MOTOR_RELAY_PIN, OUTPUT);
  digitalWrite(MOTOR_RELAY_PIN, LOW);
  digitalWrite(ALIM_RELAY_PIN, HIGH);
  delay(500);
  digitalWrite(ALIM_RELAY_PIN, LOW);
  delay(500);
  digitalWrite(MOTOR_RELAY_PIN, HIGH);
  digitalWrite(ALIM_RELAY_PIN, HIGH);
  delay(500);
  digitalWrite(ALIM_RELAY_PIN, LOW);
  digitalWrite(MOTOR_RELAY_PIN, LOW);
  Serial.begin(115200);
  delay(100);

//__________________________CSV Data Parsing____________________________

char * csv_str = "Date,Lever du soleil,Coucher du soleil,Durée du jour\n"
"2024-01-01,10:19:00,17:50:00,08:51\n"
"2024-01-02,10:19:00,17:51:00,08:52\n"
"2024-01-03,10:19:00,17:52:00,08:53\n"
"2024-01-04,10:19:00,17:53:00,08:54\n"
"2024-01-05,10:19:00,17:54:00,08:55\n"
"2024-01-06,10:19:00,17:55:00,08:56\n"
"2024-01-07,10:19:00,17:56:00,08:57\n"
"2024-01-08,10:18:00,17:57:00,08:59\n"
"2024-01-09,10:18:00,17:58:00,09:00\n"
"2024-01-10,10:18:00,17:59:00,09:01\n"
"2024-01-11,10:17:00,18:00:00,09:03\n"
"2024-01-12,10:17:00,18:02:00,09:05\n"
"2024-01-13,10:17:00,18:03:00,09:06\n"
"2024-01-14,10:16:00,18:04:00,09:08\n"
"2024-01-15,10:16:00,18:05:00,09:10\n"
"2024-01-16,10:15:00,18:06:00,09:11\n"
"2024-01-17,10:14:00,18:08:00,09:13\n"
"2024-01-18,10:14:00,18:09:00,09:15\n"
"2024-01-19,10:13:00,18:10:00,09:17\n"
"2024-01-20,10:12:00,18:12:00,09:19\n"
"2024-01-21,10:12:00,18:13:00,09:21\n"
"2024-01-22,10:11:00,18:14:00,09:23\n"
"2024-01-23,10:10:00,18:16:00,09:26\n"
"2024-01-24,10:09:00,18:17:00,09:28\n"
"2024-01-25,10:08:00,18:18:00,09:30\n"
"2024-01-26,10:07:00,18:20:00,09:32\n"
"2024-01-27,10:06:00,18:21:00,09:35\n"
"2024-01-28,10:05:00,18:23:00,09:37\n"
"2024-01-29,10:04:00,18:24:00,09:40\n"
"2024-01-30,10:03:00,18:25:00,09:42\n"
"2024-01-31,10:02:00,18:27:00,09:45\n"
"2024-02-01,10:01:00,18:28:00,09:47\n"
"2024-02-02,10:00:00,18:30:00,09:50\n"
"2024-02-03,09:59:00,18:31:00,09:52\n"
"2024-02-04,09:58:00,18:33:00,09:55\n"
"2024-02-05,09:56:00,18:34:00,09:58\n"
"2024-02-06,09:55:00,18:35:00,10:00\n"
"2024-02-07,09:54:00,18:37:00,10:03\n"
"2024-02-08,09:52:00,18:38:00,10:06\n"
"2024-02-09,09:51:00,18:40:00,10:09\n"
"2024-02-10,09:50:00,18:41:00,10:11\n"
"2024-02-11,09:48:00,18:43:00,10:14\n"
"2024-02-12,09:47:00,18:44:00,10:17\n"
"2024-02-13,09:45:00,18:45:00,10:20\n"
"2024-02-14,09:44:00,18:47:00,10:23\n"
"2024-02-15,09:42:00,18:48:00,10:26\n"
"2024-02-16,09:41:00,18:50:00,10:29\n"
"2024-02-17,09:39:00,18:51:00,10:32\n"
"2024-02-18,09:38:00,18:52:00,10:35\n"
"2024-02-19,09:36:00,18:54:00,10:38\n"
"2024-02-20,09:35:00,18:55:00,10:41\n"
"2024-02-21,09:33:00,18:57:00,10:44\n"
"2024-02-22,09:31:00,18:58:00,10:47\n"
"2024-02-23,09:30:00,18:59:00,10:50\n"
"2024-02-24,09:28:00,19:01:00,10:53\n"
"2024-02-25,09:26:00,19:02:00,10:56\n"
"2024-02-26,09:25:00,19:04:00,10:59\n"
"2024-02-27,09:23:00,19:05:00,11:02\n"
"2024-02-28,09:21:00,19:06:00,11:05\n"
"2024-02-29,09:20:00,19:08:00,11:08\n"
"2024-03-01,09:18:00,19:09:00,11:11\n"
"2024-03-02,09:16:00,19:10:00,11:14\n"
"2024-03-03,09:14:00,19:12:00,11:17\n"
"2024-03-04,09:13:00,19:13:00,11:20\n"
"2024-03-05,09:11:00,19:14:00,11:24\n"
"2024-03-06,09:09:00,19:16:00,11:27\n"
"2024-03-07,09:07:00,19:17:00,11:30\n"
"2024-03-08,09:05:00,19:18:00,11:33\n"
"2024-03-09,09:04:00,19:20:00,11:36\n"
"2024-03-10,09:02:00,19:21:00,11:39\n"
"2024-03-11,09:00:00,19:22:00,11:42\n"
"2024-03-12,08:58:00,19:24:00,11:46\n"
"2024-03-13,08:56:00,19:25:00,11:49\n"
"2024-03-14,08:54:00,19:26:00,11:52\n"
"2024-03-15,08:52:00,19:27:00,11:55\n"
"2024-03-16,08:51:00,19:29:00,11:58\n"
"2024-03-17,08:49:00,19:30:00,12:01\n"
"2024-03-18,08:47:00,19:31:00,12:04\n"
"2024-03-19,08:45:00,19:33:00,12:08\n"
"2024-03-20,08:43:00,19:34:00,12:11\n"
"2024-03-21,08:41:00,19:35:00,12:14\n"
"2024-03-22,08:39:00,19:36:00,12:17\n"
"2024-03-23,08:38:00,19:38:00,12:20\n"
"2024-03-24,08:36:00,19:39:00,12:23\n"
"2024-03-25,08:34:00,19:40:00,12:26\n"
"2024-03-26,08:32:00,19:42:00,12:30\n"
"2024-03-27,08:30:00,19:43:00,12:33\n"
"2024-03-28,08:28:00,19:44:00,12:36\n"
"2024-03-29,08:26:00,19:45:00,12:39\n"
"2024-03-30,08:24:00,19:47:00,12:42\n"
"2024-03-31,09:23:00,20:48:00,12:45\n"
"2024-04-01,09:21:00,20:49:00,12:48\n"
"2024-04-02,09:19:00,20:50:00,12:51\n"
"2024-04-03,09:17:00,20:52:00,12:55\n"
"2024-04-04,09:15:00,20:53:00,12:58\n"
"2024-04-05,09:13:00,20:54:00,13:01\n"
"2024-04-06,09:12:00,20:55:00,13:04\n"
"2024-04-07,09:10:00,20:57:00,13:07\n"
"2024-04-08,09:08:00,20:58:00,13:10\n"
"2024-04-09,09:06:00,20:59:00,13:13\n"
"2024-04-10,09:04:00,21:00:00,13:16\n"
"2024-04-11,09:03:00,21:02:00,13:19\n"
"2024-04-12,09:01:00,21:03:00,13:22\n"
"2024-04-13,08:59:00,21:04:00,13:25\n"
"2024-04-14,08:57:00,21:05:00,13:28\n"
"2024-04-15,08:55:00,21:07:00,13:31\n"
"2024-04-16,08:54:00,21:08:00,13:34\n"
"2024-04-17,08:52:00,21:09:00,13:37\n"
"2024-04-18,08:50:00,21:10:00,13:40\n"
"2024-04-19,08:49:00,21:12:00,13:43\n"
"2024-04-20,08:47:00,21:13:00,13:46\n"
"2024-04-21,08:45:00,21:14:00,13:49\n"
"2024-04-22,08:44:00,21:16:00,13:52\n"
"2024-04-23,08:42:00,21:17:00,13:55\n"
"2024-04-24,08:40:00,21:18:00,13:58\n"
"2024-04-25,08:39:00,21:19:00,14:00\n"
"2024-04-26,08:37:00,21:21:00,14:03\n"
"2024-04-27,08:36:00,21:22:00,14:06\n"
"2024-04-28,08:34:00,21:23:00,14:09\n"
"2024-04-29,08:33:00,21:24:00,14:12\n"
"2024-04-30,08:31:00,21:25:00,14:14\n"
"2024-05-01,08:30:00,21:27:00,14:17\n"
"2024-05-02,08:28:00,21:28:00,14:20\n"
"2024-05-03,08:27:00,21:29:00,14:22\n"
"2024-05-04,08:25:00,21:30:00,14:25\n"
"2024-05-05,08:24:00,21:32:00,14:28\n"
"2024-05-06,08:23:00,21:33:00,14:30\n"
"2024-05-07,08:21:00,21:34:00,14:33\n"
"2024-05-08,08:20:00,21:35:00,14:35\n"
"2024-05-09,08:19:00,21:36:00,14:38\n"
"2024-05-10,08:18:00,21:38:00,14:40\n"
"2024-05-11,08:16:00,21:39:00,14:43\n"
"2024-05-12,08:15:00,21:40:00,14:45\n"
"2024-05-13,08:14:00,21:41:00,14:47\n"
"2024-05-14,08:13:00,21:42:00,14:50\n"
"2024-05-15,08:12:00,21:43:00,14:52\n"
"2024-05-16,08:11:00,21:45:00,14:54\n"
"2024-05-17,08:10:00,21:46:00,14:56\n"
"2024-05-18,08:08:00,21:47:00,14:58\n"
"2024-05-19,08:07:00,21:48:00,15:00\n"
"2024-05-20,08:07:00,21:49:00,15:02\n"
"2024-05-21,08:06:00,21:50:00,15:04\n"
"2024-05-22,08:05:00,21:51:00,15:06\n"
"2024-05-23,08:04:00,21:52:00,15:08\n"
"2024-05-24,08:03:00,21:53:00,15:10\n"
"2024-05-25,08:02:00,21:54:00,15:12\n"
"2024-05-26,08:01:00,21:55:00,15:14\n"
"2024-05-27,08:01:00,21:56:00,15:15\n"
"2024-05-28,08:00:00,21:57:00,15:17\n"
"2024-05-29,07:59:00,21:58:00,15:19\n"
"2024-05-30,07:59:00,21:59:00,15:20\n"
"2024-05-31,07:58:00,22:00:00,15:21\n"
"2024-06-01,07:58:00,22:01:00,15:23\n"
"2024-06-02,07:57:00,22:01:00,15:24\n"
"2024-06-03,07:57:00,22:02:00,15:25\n"
"2024-06-04,07:56:00,22:03:00,15:27\n"
"2024-06-05,07:56:00,22:04:00,15:28\n"
"2024-06-06,07:56:00,22:04:00,15:29\n"
"2024-06-07,07:55:00,22:05:00,15:30\n"
"2024-06-08,07:55:00,22:06:00,15:31\n"
"2024-06-09,07:55:00,22:06:00,15:32\n"
"2024-06-10,07:55:00,22:07:00,15:32\n"
"2024-06-11,07:54:00,22:08:00,15:33\n"
"2024-06-12,07:54:00,22:08:00,15:34\n"
"2024-06-13,07:54:00,22:09:00,15:34\n"
"2024-06-14,07:54:00,22:09:00,15:35\n"
"2024-06-15,07:54:00,22:09:00,15:35\n"
"2024-06-16,07:54:00,22:10:00,15:36\n"
"2024-06-17,07:54:00,22:10:00,15:36\n"
"2024-06-18,07:54:00,22:11:00,15:36\n"
"2024-06-19,07:55:00,22:11:00,15:36\n"
"2024-06-20,07:55:00,22:11:00,15:36\n"
"2024-06-21,07:55:00,22:11:00,15:36\n"
"2024-06-22,07:55:00,22:11:00,15:36\n"
"2024-06-23,07:55:00,22:12:00,15:36\n"
"2024-06-24,07:56:00,22:12:00,15:36\n"
"2024-06-25,07:56:00,22:12:00,15:36\n"
"2024-06-26,07:57:00,22:12:00,15:35\n"
"2024-06-27,07:57:00,22:12:00,15:35\n"
"2024-06-28,07:57:00,22:12:00,15:34\n"
"2024-06-29,07:58:00,22:12:00,15:34\n"
"2024-06-30,07:59:00,22:11:00,15:33\n"
"2024-07-01,07:59:00,22:11:00,15:32\n"
"2024-07-02,08:00:00,22:11:00,15:31\n"
"2024-07-03,08:00:00,22:11:00,15:31\n"
"2024-07-04,08:01:00,22:11:00,15:30\n"
"2024-07-05,08:02:00,22:10:00,15:29\n"
"2024-07-06,08:02:00,22:10:00,15:28\n"
"2024-07-07,08:03:00,22:09:00,15:26\n"
"2024-07-08,08:04:00,22:09:00,15:25\n"
"2024-07-09,08:05:00,22:08:00,15:24\n"
"2024-07-10,08:05:00,22:08:00,15:23\n"
"2024-07-11,08:06:00,22:07:00,15:21\n"
"2024-07-12,08:07:00,22:07:00,15:20\n"
"2024-07-13,08:08:00,22:06:00,15:18\n"
"2024-07-14,08:09:00,22:05:00,15:17\n"
"2024-07-15,08:10:00,22:05:00,15:15\n"
"2024-07-16,08:11:00,22:04:00,15:13\n"
"2024-07-17,08:12:00,22:03:00,15:12\n"
"2024-07-18,08:13:00,22:02:00,15:10\n"
"2024-07-19,08:14:00,22:02:00,15:08\n"
"2024-07-20,08:15:00,22:01:00,15:06\n"
"2024-07-21,08:16:00,22:00:00,15:04\n"
"2024-07-22,08:17:00,21:59:00,15:02\n"
"2024-07-23,08:18:00,21:58:00,15:00\n"
"2024-07-24,08:19:00,21:57:00,14:58\n"
"2024-07-25,08:20:00,21:56:00,14:56\n"
"2024-07-26,08:21:00,21:55:00,14:54\n"
"2024-07-27,08:22:00,21:54:00,14:52\n"
"2024-07-28,08:23:00,21:52:00,14:49\n"
"2024-07-29,08:24:00,21:51:00,14:47\n"
"2024-07-30,08:25:00,21:50:00,14:45\n"
"2024-07-31,08:26:00,21:49:00,14:42\n"
"2024-08-01,08:27:00,21:48:00,14:40\n"
"2024-08-02,08:29:00,21:46:00,14:38\n"
"2024-08-03,08:30:00,21:45:00,14:35\n"
"2024-08-04,08:31:00,21:44:00,14:33\n"
"2024-08-05,08:32:00,21:42:00,14:30\n"
"2024-08-06,08:33:00,21:41:00,14:28\n"
"2024-08-07,08:34:00,21:39:00,14:25\n"
"2024-08-08,08:36:00,21:38:00,14:22\n"
"2024-08-09,08:37:00,21:37:00,14:20\n"
"2024-08-10,08:38:00,21:35:00,14:17\n"
"2024-08-11,08:39:00,21:34:00,14:14\n"
"2024-08-12,08:40:00,21:32:00,14:12\n"
"2024-08-13,08:41:00,21:30:00,14:09\n"
"2024-08-14,08:43:00,21:29:00,14:06\n"
"2024-08-15,08:44:00,21:27:00,14:04\n"
"2024-08-16,08:45:00,21:26:00,14:01\n"
"2024-08-17,08:46:00,21:24:00,13:58\n"
"2024-08-18,08:47:00,21:23:00,13:55\n"
"2024-08-19,08:49:00,21:21:00,13:52\n"
"2024-08-20,08:50:00,21:19:00,13:49\n"
"2024-08-21,08:51:00,21:17:00,13:47\n"
"2024-08-22,08:52:00,21:16:00,13:44\n"
"2024-08-23,08:53:00,21:14:00,13:41\n"
"2024-08-24,08:54:00,21:12:00,13:38\n"
"2024-08-25,08:56:00,21:11:00,13:35\n"
"2024-08-26,08:57:00,21:09:00,13:32\n"
"2024-08-27,08:58:00,21:07:00,13:29\n"
"2024-08-28,08:59:00,21:05:00,13:26\n"
"2024-08-29,09:00:00,21:04:00,13:23\n"
"2024-08-30,09:02:00,21:02:00,13:20\n"
"2024-08-31,09:03:00,21:00:00,13:17\n"
"2024-09-01,09:04:00,20:58:00,13:14\n"
"2024-09-02,09:05:00,20:56:00,13:11\n"
"2024-09-03,09:06:00,20:54:00,13:08\n"
"2024-09-04,09:08:00,20:53:00,13:05\n"
"2024-09-05,09:09:00,20:51:00,13:02\n"
"2024-09-06,09:10:00,20:49:00,12:59\n"
"2024-09-07,09:11:00,20:47:00,12:56\n"
"2024-09-08,09:12:00,20:45:00,12:53\n"
"2024-09-09,09:13:00,20:43:00,12:50\n"
"2024-09-10,09:15:00,20:41:00,12:47\n"
"2024-09-11,09:16:00,20:39:00,12:44\n"
"2024-09-12,09:17:00,20:38:00,12:41\n"
"2024-09-13,09:18:00,20:36:00,12:38\n"
"2024-09-14,09:19:00,20:34:00,12:34\n"
"2024-09-15,09:21:00,20:32:00,12:31\n"
"2024-09-16,09:22:00,20:30:00,12:28\n"
"2024-09-17,09:23:00,20:28:00,12:25\n"
"2024-09-18,09:24:00,20:26:00,12:22\n"
"2024-09-19,09:25:00,20:24:00,12:19\n"
"2024-09-20,09:26:00,20:22:00,12:16\n"
"2024-09-21,09:28:00,20:20:00,12:13\n"
"2024-09-22,09:29:00,20:19:00,12:10\n"
"2024-09-23,09:30:00,20:17:00,12:07\n"
"2024-09-24,09:31:00,20:15:00,12:03\n"
"2024-09-25,09:32:00,20:13:00,12:00\n"
"2024-09-26,09:34:00,20:11:00,11:57\n"
"2024-09-27,09:35:00,20:09:00,11:54\n"
"2024-09-28,09:36:00,20:07:00,11:51\n"
"2024-09-29,09:37:00,20:05:00,11:48\n"
"2024-09-30,09:39:00,20:03:00,11:45\n"
"2024-10-01,09:40:00,20:02:00,11:42\n"
"2024-10-02,09:41:00,20:00:00,11:39\n"
"2024-10-03,09:42:00,19:58:00,11:36\n"
"2024-10-04,09:43:00,19:56:00,11:32\n"
"2024-10-05,09:45:00,19:54:00,11:29\n"
"2024-10-06,09:46:00,19:52:00,11:26\n"
"2024-10-07,09:47:00,19:50:00,11:23\n"
"2024-10-08,09:48:00,19:49:00,11:20\n"
"2024-10-09,09:50:00,19:47:00,11:17\n"
"2024-10-10,09:51:00,19:45:00,11:14\n"
"2024-10-11,09:52:00,19:43:00,11:11\n"
"2024-10-12,09:54:00,19:42:00,11:08\n"
"2024-10-13,09:55:00,19:40:00,11:05\n"
"2024-10-14,09:56:00,19:38:00,11:02\n"
"2024-10-15,09:57:00,19:36:00,10:59\n"
"2024-10-16,09:59:00,19:35:00,10:56\n"
"2024-10-17,10:00:00,19:33:00,10:53\n"
"2024-10-18,10:01:00,19:31:00,10:50\n"
"2024-10-19,10:03:00,19:29:00,10:47\n"
"2024-10-20,10:04:00,19:28:00,10:44\n"
"2024-10-21,10:05:00,19:26:00,10:41\n"
"2024-10-22,10:07:00,19:25:00,10:38\n"
"2024-10-23,10:08:00,19:23:00,10:35\n"
"2024-10-24,10:09:00,19:21:00,10:32\n"
"2024-10-25,10:11:00,19:20:00,10:29\n"
"2024-10-26,10:12:00,19:18:00,10:26\n"
"2024-10-27,09:13:00,18:17:00,10:23\n"
"2024-10-28,09:15:00,18:15:00,10:21\n"
"2024-10-29,09:16:00,18:14:00,10:18\n"
"2024-10-30,09:17:00,18:12:00,10:15\n"
"2024-10-31,09:19:00,18:11:00,10:12\n"
"2024-11-01,09:20:00,18:09:00,10:09\n"
"2024-11-02,09:21:00,18:08:00,10:07\n"
"2024-11-03,09:23:00,18:07:00,10:04\n"
"2024-11-04,09:24:00,18:05:00,10:01\n"
"2024-11-05,09:26:00,18:04:00,09:58\n"
"2024-11-06,09:27:00,18:03:00,09:56\n"
"2024-11-07,09:28:00,18:01:00,09:53\n"
"2024-11-08,09:30:00,18:00:00,09:51\n"
"2024-11-09,09:31:00,17:59:00,09:48\n"
"2024-11-10,09:32:00,17:58:00,09:45\n"
"2024-11-11,09:34:00,17:57:00,09:43\n"
"2024-11-12,09:35:00,17:56:00,09:40\n"
"2024-11-13,09:37:00,17:55:00,09:38\n"
"2024-11-14,09:38:00,17:54:00,09:36\n"
"2024-11-15,09:39:00,17:53:00,09:33\n"
"2024-11-16,09:41:00,17:52:00,09:31\n"
"2024-11-17,09:42:00,17:51:00,09:29\n"
"2024-11-18,09:43:00,17:50:00,09:26\n"
"2024-11-19,09:45:00,17:49:00,09:24\n"
"2024-11-20,09:46:00,17:48:00,09:22\n"
"2024-11-21,09:47:00,17:47:00,09:20\n"
"2024-11-22,09:48:00,17:46:00,09:18\n"
"2024-11-23,09:50:00,17:46:00,09:16\n"
"2024-11-24,09:51:00,17:45:00,09:14\n"
"2024-11-25,09:52:00,17:44:00,09:12\n"
"2024-11-26,09:53:00,17:44:00,09:10\n"
"2024-11-27,09:55:00,17:43:00,09:09\n"
"2024-11-28,09:56:00,17:43:00,09:07\n"
"2024-11-29,09:57:00,17:42:00,09:05\n"
"2024-11-30,09:58:00,17:42:00,09:04\n"
"2024-12-01,09:59:00,17:41:00,09:02\n"
"2024-12-02,10:00:00,17:41:00,09:01\n"
"2024-12-03,10:01:00,17:41:00,08:59\n"
"2024-12-04,10:03:00,17:41:00,08:58\n"
"2024-12-05,10:04:00,17:40:00,08:57\n"
"2024-12-06,10:05:00,17:40:00,08:56\n"
"2024-12-07,10:06:00,17:40:00,08:54\n"
"2024-12-08,10:07:00,17:40:00,08:53\n"
"2024-12-09,10:07:00,17:40:00,08:52\n"
"2024-12-10,10:08:00,17:40:00,08:52\n"
"2024-12-11,10:09:00,17:40:00,08:51\n"
"2024-12-12,10:10:00,17:40:00,08:50\n"
"2024-12-13,10:11:00,17:40:00,08:49\n"
"2024-12-14,10:12:00,17:40:00,08:49\n"
"2024-12-15,10:12:00,17:41:00,08:48\n"
"2024-12-16,10:13:00,17:41:00,08:48\n"
"2024-12-17,10:14:00,17:41:00,08:47\n"
"2024-12-18,10:14:00,17:42:00,08:47\n"
"2024-12-19,10:15:00,17:42:00,08:47\n"
"2024-12-20,10:16:00,17:42:00,08:47\n"
"2024-12-21,10:16:00,17:43:00,08:47\n"
"2024-12-22,10:17:00,17:43:00,08:47\n"
"2024-12-23,10:17:00,17:44:00,08:47\n"
"2024-12-24,10:17:00,17:45:00,08:47\n"
"2024-12-25,10:18:00,17:45:00,08:48\n"
"2024-12-26,10:18:00,17:46:00,08:48\n"
"2024-12-27,10:18:00,17:47:00,08:48\n"
"2024-12-28,10:19:00,17:47:00,08:49\n"
"2024-12-29,10:19:00,17:48:00,08:49\n"
"2024-12-30,10:19:00,17:49:00,08:50\n"
"2024-12-31,10:19:00,17:50:00,08:51\n";
                 
   CSV_Parser cp(csv_str, /*format*/ "ssss");


  Serial.println("Accessing values by column number:");
  dates_CSV = (char**)cp[0];
  lever_CSV = (char**)cp[1];
  coucher_CSV = (char**)cp[2];
  cp.print();

//__________________________WIFI Begin____________________________

   WiFi.begin(ssid, password);
  while ( WiFi.status() != WL_CONNECTED ) {
    delay ( 500 );
    Serial.print ( "." );
    }

    Serial.print("Ip Adress :" );
    Serial.println(WiFi.localIP());
  timeClient.begin();

//_________________________Webserial Setup__________________________

  server.on("/", HTTP_GET, [](AsyncWebServerRequest *request) {
    request->send(200, "text/plain", "Hi! You can access the WebSerial interface at http://" + WiFi.localIP().toString() + "/webserial");
  });
  WebSerial.begin(&server);
  WebSerial.onMessage([](uint8_t *data, size_t len) {
    Serial.printf("Received %lu bytes from WebSerial: ", len);
    Serial.write(data, len);
    Serial.println();
    WebSerial.println("Received Data...");
    String d = "";
    for(size_t i = 0; i < len; i++){
      d += char(data[i]);
    }
    WebSerial.println(d);
  });
  server.begin();
  
}

void openDoorFunction() {
  digitalWrite(MOTOR_RELAY_PIN, LOW);
  delay (1000);
  digitalWrite(ALIM_RELAY_PIN, HIGH);
  delay (timeToOpen_ms);
  digitalWrite(ALIM_RELAY_PIN, LOW);
}
void closeDoorFunction() {
  digitalWrite(MOTOR_RELAY_PIN, HIGH);
  delay (1000);
  digitalWrite(ALIM_RELAY_PIN, HIGH);
  delay (timeToClose_ms);
  digitalWrite(ALIM_RELAY_PIN, LOW);
}


//____________________________LOOP_________________________________

void loop() {
//_______________________WebSerial__________________________  

  WebSerial.loop();
  timeClient.update();

static unsigned long last_print_time = millis();
  
// Check & print every 15secs/ Async
if ((unsigned long)(millis() - last_print_time) > 10000) { 
 

//_______________________Time Alarms and shit__________________________
  epoch = timeClient.getEpochTime();
  dayVar = day(epoch);
  monthVar = month(epoch);
  yearVar = year(epoch);
  int currentHourVar = hour(epoch);
  int currentMinVar = minute(epoch);


// Creating one String for the whole Timeclient date
  String dayStr = String(dayVar);
  String monthStr = String(monthVar);
  String yearStr = String(yearVar);
  String currentHour = String(currentHourVar);
  String currentMin = String(currentMinVar);
  
  if (currentHourVar < 10)
      {currentHour = "0" + currentHour;}
  if (currentMinVar < 10)
      {currentMin = "0" + currentMin;}
  if (monthVar < 10)
      {monthStr = "0" + monthStr;}
  String dateStr = yearStr + "-" + monthStr + "-" + dayStr;

// Accessing data by day number
  dayNumber = 30*(monthVar-1);
  dayNumber += dayVar;
  leverStr = String(lever_CSV[dayNumber]);
  coucherStr = String(coucher_CSV[dayNumber]);
  sunriseHour = leverStr.substring(0,2);
  sunriseMin = leverStr.substring(3,5);
  sunsetHour = coucherStr.substring(0,2);
  sunsetMin = coucherStr.substring(3,5);

  //sunriseHour = sunriseHourStr.toInt();
  //sunriseMin = sunriseMinStr.toInt();
  //sunsetHour = sunsetHourStr.toInt();
  //sunsetMin = sunsetMinStr.toInt();

  //sunriseHour += riseOffsetHour;
  //sunriseMin += riseOffsetMin;
  //sunsetHour += setOffsetHour;
  //sunsetMin += setOffsetMin;

  
  if ((currentHour > sunriseHour && currentHour < sunsetHour) ||
      (currentHour == sunriseHour && currentMin >= sunriseMin) ||
      (currentHour == sunsetHour && currentMin <= sunsetMin)) {
        isDaytime = true; // Il fait jour
        WebSerial.println("Il fait jour ");
        WebSerial.println("________________________________");
        } 
      else {
        isDaytime = false; // Il fait nuit
        WebSerial.println("Il fait nuit ");
        WebSerial.println("________________________________");
        }
    if (isDaytime != doorIsOpen) {
       if (doorIsOpen) {
         closeDoorFunction();
         doorIsOpen = false;
         WebSerial.println("La porte a été fermée");
         WebSerial.println("________________________________");
          }
        else {
        openDoorFunction();
        doorIsOpen = true;
        WebSerial.println("La porte a été ouverte");
        WebSerial.println("________________________________");
          }
       }
    else {
      WebSerial.println("La porte reste dans son état précédent");
      WebSerial.println("________________________________");
    }


//________________________________________Serial Debuging_________________________________

  WebSerial.print("\nHeure : ");
  WebSerial.print(currentHour + ":" + currentMin);
  WebSerial.print("\nDate :");
  WebSerial.print(dateStr);
  WebSerial.print("\nHeure Lever: ");
  WebSerial.print(sunriseHour + ":" + sunriseMin);
  WebSerial.print("\nHeure coucher: ");
  WebSerial.print(sunsetHour + ":" + sunsetMin);
  WebSerial.print("\n=====================");
  WebSerial.print("\n");
  WebSerial.printf("Uptime: %lums\n", millis());
  WebSerial.printf("Free heap: %u\n", ESP.getFreeHeap());
    last_print_time = millis();
  }
}